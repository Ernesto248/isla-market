# üöÄ Plan de Implementaci√≥n - Isla Market

## Funcionalidades Pendientes y Mejoras

---

## üìä Estado Actual de la Aplicaci√≥n

### ‚úÖ **Funcionalidades Implementadas**

- **Frontend Completo:**

  - Home page con hero, categor√≠as y productos destacados
  - Cat√°logo de productos con filtros y b√∫squeda
  - Sistema de carrito de compras (Zustand + localStorage)
  - Checkout con formulario de direcci√≥n cubana
  - P√°gina de √≥rdenes del usuario
  - Sistema de autenticaci√≥n (login/signup)
  - Internacionalizaci√≥n (ES/EN)
  - Modo oscuro/claro
  - Dise√±o responsivo completo

- **Backend APIs:**

  - CRUD completo de productos (`/api/products`)
  - CRUD completo de categor√≠as (`/api/categories`)
  - Gesti√≥n de √≥rdenes (`/api/orders`)
  - Integraci√≥n con Stripe (checkout + webhooks)
  - Integraci√≥n con Supabase (PostgreSQL)
  - Sistema de autenticaci√≥n con Supabase Auth

- **Infraestructura:**
  - Base de datos PostgreSQL en Supabase
  - Pol√≠ticas RLS b√°sicas
  - Deployment en Vercel
  - Variables de entorno configuradas

### üî¥ **Funcionalidades Faltantes Identificadas**

1. **Panel de Administraci√≥n** (CR√çTICO)
2. **Sistema de Emails** (IMPORTANTE)
3. **Otras Mejoras Necesarias** (VER AN√ÅLISIS DETALLADO)

---

## üéØ FASE 1: PANEL DE ADMINISTRACI√ìN

### **Prioridad:** üî¥ CR√çTICA

### **Tiempo estimado:** 4-6 d√≠as

### **Complejidad:** Alta

### 1.1 Dashboard Interactivo

#### **Componentes a Crear:**

```
app/
  admin/
    layout.tsx              # Layout espec√≠fico de admin con sidebar
    page.tsx                # Dashboard principal
    products/
      page.tsx              # Lista de productos con acciones
      [id]/
        page.tsx            # Editar producto
      new/
        page.tsx            # Crear producto nuevo
    categories/
      page.tsx              # Gesti√≥n de categor√≠as
    orders/
      page.tsx              # Gesti√≥n de √≥rdenes
      [id]/
        page.tsx            # Detalle de orden
    analytics/
      page.tsx              # P√°gina de an√°lisis y reportes

components/
  admin/
    admin-guard.tsx         # Guard para verificar rol de admin
    dashboard/
      stats-card.tsx        # Tarjeta de estad√≠sticas
      sales-chart.tsx       # Gr√°fico de ventas
      orders-table.tsx      # Tabla de √≥rdenes recientes
      top-products.tsx      # Lista de productos m√°s vendidos
    products/
      product-form.tsx      # Formulario de producto
      product-list.tsx      # Lista con acciones
      image-upload.tsx      # Componente para subir im√°genes
    orders/
      order-detail.tsx      # Detalle completo de orden
      order-status-badge.tsx # Badge de estado
      shipping-info.tsx     # Info de env√≠o
```

#### **APIs a Crear/Mejorar:**

```typescript
// app/api/admin/stats/route.ts
GET /api/admin/stats
- Retorna estad√≠sticas del dashboard:
  * Total de ventas (hoy, semana, mes, a√±o)
  * Total de √≥rdenes por estado
  * Productos m√°s vendidos
  * Ingresos por d√≠a/semana/mes
  * √ìrdenes recientes
  * Stock bajo

// app/api/admin/orders/route.ts
GET /api/admin/orders?status=&page=&limit=
- Lista todas las √≥rdenes con paginaci√≥n
- Filtros por estado, fecha, cliente

PATCH /api/admin/orders/[id]/status
- Actualizar estado de una orden

// app/api/admin/products/route.ts
POST /api/admin/products
- Crear producto con validaci√≥n de admin

PUT /api/admin/products/[id]
- Actualizar producto

DELETE /api/admin/products/[id]
- Eliminar producto (soft delete)

// app/api/admin/analytics/route.ts
GET /api/admin/analytics?period=
- An√°lisis detallado por per√≠odo
  * Ventas diarias/semanales/mensuales
  * Comparaci√≥n con per√≠odo anterior
  * Trending products
  * Provincias con m√°s √≥rdenes
```

#### **M√©tricas del Dashboard:**

1. **Tarjetas de Estad√≠sticas Principales:**

   - üí∞ Ventas Totales (hoy, semana, mes)
   - üì¶ Total de √ìrdenes
   - ‚è≥ √ìrdenes Pendientes
   - ‚úÖ √ìrdenes Completadas
   - üì¶ Productos en Cat√°logo
   - ‚ö†Ô∏è Productos con Stock Bajo

2. **Gr√°ficos:**

   - üìà **Ventas por Tiempo:** Line chart (√∫ltimos 30 d√≠as)
   - üìä **√ìrdenes por Estado:** Pie chart
   - üèÜ **Top 10 Productos:** Bar chart
   - üó∫Ô∏è **Ventas por Provincia:** Map chart

3. **Tablas:**
   - üïí **√ìrdenes Recientes:** √öltimas 10 con acciones r√°pidas
   - üî• **Productos Destacados:** M√°s vendidos del mes
   - ‚ö†Ô∏è **Alertas:** Stock bajo, √≥rdenes pendientes

#### **Librer√≠as Recomendadas:**

```json
{
  "recharts": "^2.10.0", // Gr√°ficos
  "date-fns": "^3.0.0", // Manejo de fechas
  "react-hot-toast": "^2.4.1", // Ya instalado
  "@tanstack/react-table": "^8.11.0", // Tablas avanzadas
  "react-dropzone": "^14.2.0" // Upload de im√°genes
}
```

#### **Checklist de Implementaci√≥n:**

**Backend (2-3 d√≠as):**

- [ ] Crear API de estad√≠sticas `/api/admin/stats`
- [ ] Crear API de analytics `/api/admin/analytics`
- [ ] Mejorar APIs de productos con validaci√≥n admin
- [ ] Agregar middleware de verificaci√≥n de rol admin
- [ ] Crear queries optimizadas en Supabase
- [ ] Agregar √≠ndices en BD para performance

**Frontend (2-3 d√≠as):**

- [ ] Crear AdminGuard component
- [ ] Layout de admin con sidebar responsivo
- [ ] Dashboard principal con stats cards
- [ ] Implementar gr√°ficos con Recharts
- [ ] Tabla de √≥rdenes con filtros y paginaci√≥n
- [ ] Formulario de productos con validaci√≥n
- [ ] Sistema de upload de im√°genes
- [ ] P√°ginas de gesti√≥n de categor√≠as
- [ ] P√°gina de analytics detallado

**Testing y Optimizaci√≥n (1 d√≠a):**

- [ ] Probar flujo completo de admin
- [ ] Optimizar queries lentas
- [ ] Implementar caching donde sea necesario
- [ ] Responsive testing

---

## üìß FASE 2: SISTEMA DE EMAILS CON RESEND

### **Prioridad:** üü° IMPORTANTE

### **Tiempo estimado:** 2-3 d√≠as

### **Complejidad:** Media

### 2.1 Configuraci√≥n de Resend

#### **Setup Inicial:**

```bash
# Instalar Resend
pnpm add resend

# Agregar variable de entorno
RESEND_API_KEY=re_xxxxxxxxxxxxx
```

#### **Estructura de Archivos:**

```
lib/
  email/
    resend.ts              # Cliente de Resend
    templates/
      order-confirmation.tsx  # Template de confirmaci√≥n
      order-shipped.tsx       # Template de env√≠o
      order-delivered.tsx     # Template de entrega
      password-reset.tsx      # Template reset password
      welcome.tsx             # Template bienvenida

app/api/
  email/
    send/route.ts          # Endpoint para enviar emails
    test/route.ts          # Endpoint de prueba
```

#### **Templates de Emails a Crear:**

1. **üõí Confirmaci√≥n de Orden**

   - Trigger: Despu√©s de pago exitoso
   - Contenido:
     - N√∫mero de orden
     - Resumen de productos
     - Direcci√≥n de env√≠o
     - Total pagado
     - Tiempo estimado de entrega

2. **üì¶ Orden Enviada**

   - Trigger: Admin marca orden como "shipped"
   - Contenido:
     - N√∫mero de tracking (si aplica)
     - Productos enviados
     - Fecha estimada de llegada

3. **‚úÖ Orden Entregada**

   - Trigger: Admin marca orden como "delivered"
   - Contenido:
     - Confirmaci√≥n de entrega
     - Solicitar feedback
     - Link a p√°gina de review

4. **üëã Email de Bienvenida**

   - Trigger: Registro nuevo
   - Contenido:
     - Bienvenida personalizada
     - C√≥mo funciona el servicio
     - Categor√≠as destacadas
     - Cup√≥n de descuento (opcional)

5. **üîê Reset de Contrase√±a**

   - Trigger: Usuario solicita reset
   - Contenido:
     - Link seguro de reset
     - Expiraci√≥n del link
     - Instrucciones

6. **‚ùå Orden Cancelada**
   - Trigger: Cancelaci√≥n de orden
   - Contenido:
     - Raz√≥n de cancelaci√≥n
     - Informaci√≥n de reembolso
     - Alternativas

#### **Implementaci√≥n:**

```typescript
// lib/email/resend.ts
import { Resend } from "resend";

const resend = new Resend(process.env.RESEND_API_KEY);

export const sendEmail = async ({
  to,
  subject,
  template,
  data,
}: {
  to: string;
  subject: string;
  template: React.ReactElement;
  data?: any;
}) => {
  try {
    const { data: emailData, error } = await resend.emails.send({
      from: "Isla Market <orders@islamarket.com>",
      to,
      subject,
      react: template,
    });

    if (error) {
      console.error("Error sending email:", error);
      throw error;
    }

    return emailData;
  } catch (error) {
    console.error("Failed to send email:", error);
    throw error;
  }
};

// Funciones espec√≠ficas
export const sendOrderConfirmation = async (
  order: Order,
  userEmail: string
) => {
  return sendEmail({
    to: userEmail,
    subject: `Confirmaci√≥n de Orden #${order.id.slice(0, 8)}`,
    template: <OrderConfirmationEmail order={order} />,
  });
};
```

#### **API para Enviar Emails:**

```typescript
// app/api/email/send/route.ts
import { sendEmail } from "@/lib/email/resend";
import { createSupabaseAdmin } from "@/lib/supabase";

export async function POST(request: Request) {
  try {
    const { type, orderId, userId } = await request.json();

    // Verificar autenticaci√≥n/autorizaci√≥n
    // ...

    // Obtener datos necesarios
    const supabase = createSupabaseAdmin();
    // ...

    // Enviar email seg√∫n tipo
    switch (type) {
      case "order-confirmation":
        await sendOrderConfirmation(order, userEmail);
        break;
      // ... otros casos
    }

    return Response.json({ success: true });
  } catch (error) {
    return Response.json({ error: error.message }, { status: 500 });
  }
}
```

#### **Integraci√≥n con Webhooks de Stripe:**

```typescript
// En app/api/stripe/webhook/route.ts
// Despu√©s de crear la orden exitosamente

if (session.payment_status === "paid") {
  // Crear orden en BD
  const order = await createOrder(session);

  // Enviar email de confirmaci√≥n
  await sendOrderConfirmation(order, session.customer_email);
}
```

#### **Checklist de Implementaci√≥n:**

- [ ] Configurar cuenta en Resend
- [ ] Configurar dominio y DNS
- [ ] Crear templates de emails con React
- [ ] Implementar funci√≥n sendEmail
- [ ] Crear API endpoint `/api/email/send`
- [ ] Integrar con webhook de Stripe
- [ ] Integrar con cambios de estado de √≥rdenes
- [ ] Agregar emails a proceso de registro
- [ ] Crear p√°gina de test de emails
- [ ] Agregar logging de emails enviados
- [ ] Probar todos los flujos

---

## üé® FASE 3: MEJORAS ADICIONALES RECOMENDADAS

### **Prioridad:** üü¢ DESEABLE

### **Tiempo estimado:** 5-7 d√≠as

### 3.1 Sistema de Notificaciones en Tiempo Real

**Herramientas:** Supabase Realtime

**Caracter√≠sticas:**

- üîî Notificaciones de nuevas √≥rdenes para admins
- üì¶ Actualizaciones de estado de orden para clientes
- üí¨ Sistema de mensajer√≠a admin-cliente
- ‚ö° Toast notifications en UI

**Implementaci√≥n:**

```typescript
// lib/realtime.ts
export function subscribeToOrders(userId: string, callback: Function) {
  return supabase
    .channel("orders")
    .on(
      "postgres_changes",
      {
        event: "INSERT",
        schema: "public",
        table: "orders",
        filter: `user_id=eq.${userId}`,
      },
      callback
    )
    .subscribe();
}
```

---

### 3.2 Sistema de Reviews y Ratings

**Caracter√≠sticas:**

- ‚≠ê Rating de productos (1-5 estrellas)
- üí¨ Comentarios de clientes
- üì∏ Fotos en reviews
- ‚úÖ Verificaci√≥n de compra
- üëç Helpful/Not helpful votes

**Base de Datos:**

```sql
CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  product_id UUID REFERENCES products(id),
  user_id UUID REFERENCES auth.users(id),
  order_id UUID REFERENCES orders(id),
  rating INTEGER CHECK (rating >= 1 AND rating <= 5),
  comment TEXT,
  images TEXT[],
  is_verified_purchase BOOLEAN DEFAULT false,
  helpful_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

---

### 3.3 Sistema de Cupones y Descuentos

**Caracter√≠sticas:**

- üéüÔ∏è C√≥digos de descuento
- üí∞ Descuentos por porcentaje o monto fijo
- üìÖ Fechas de validez
- üî¢ L√≠mite de usos
- üë• Descuentos por primera compra
- üéÅ Cupones de referidos

**Base de Datos:**

```sql
CREATE TABLE coupons (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  code VARCHAR(50) UNIQUE NOT NULL,
  discount_type VARCHAR(20) CHECK (discount_type IN ('percentage', 'fixed')),
  discount_value DECIMAL(10,2) NOT NULL,
  min_purchase_amount DECIMAL(10,2),
  max_uses INTEGER,
  uses_count INTEGER DEFAULT 0,
  valid_from TIMESTAMP,
  valid_until TIMESTAMP,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE coupon_uses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  coupon_id UUID REFERENCES coupons(id),
  user_id UUID REFERENCES auth.users(id),
  order_id UUID REFERENCES orders(id),
  discount_applied DECIMAL(10,2),
  used_at TIMESTAMP DEFAULT NOW()
);
```

---

### 3.4 Tracking de Env√≠os

**Caracter√≠sticas:**

- üìç Estado de env√≠o en tiempo real
- üó∫Ô∏è Mapa con ubicaci√≥n del paquete
- üìß Notificaciones de cambios de estado
- üì± Link de tracking p√∫blico

**Estados de Env√≠o:**

1. Orden Recibida
2. En Preparaci√≥n
3. En Tr√°nsito a Cuba
4. En Aduana
5. En Distribuci√≥n Local
6. En Ruta de Entrega
7. Entregado

---

### 3.5 Wishlist / Lista de Deseos

**Caracter√≠sticas:**

- ‚ù§Ô∏è Agregar productos a favoritos
- üîî Notificar cuando baje de precio
- üìß Notificar cuando vuelva a stock
- üì§ Compartir wishlist

---

### 3.6 Programa de Referidos

**Caracter√≠sticas:**

- üë• C√≥digo de referido √∫nico por usuario
- üí∞ Cr√©ditos por referidos exitosos
- üìä Dashboard de referidos
- üèÜ Niveles de recompensas

---

### 3.7 Mejoras de Seguridad

**Implementaciones Necesarias:**

1. **Rate Limiting:**

```typescript
// middleware.ts
import { Ratelimit } from "@upstash/ratelimit";
import { Redis } from "@upstash/redis";

const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(10, "10 s"),
});
```

2. **Verificaci√≥n de Email:**

- Supabase ya provee esto
- Implementar flujo de verificaci√≥n obligatoria

3. **2FA Opcional:**

- Para admins (obligatorio)
- Para clientes (opcional)

4. **Logs de Auditor√≠a:**

```sql
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id),
  action VARCHAR(100) NOT NULL,
  entity_type VARCHAR(50),
  entity_id UUID,
  changes JSONB,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

### 3.8 Mejoras de UX

**Implementaciones:**

1. **B√∫squeda Avanzada:**

   - Autocompletado
   - B√∫squeda por voz
   - Filtros avanzados
   - Historial de b√∫squedas

2. **Carrito Mejorado:**

   - Guardar para despu√©s
   - Productos sugeridos relacionados
   - C√°lculo de impuestos y env√≠o en tiempo real

3. **Onboarding:**

   - Tour guiado para nuevos usuarios
   - Tips contextuales
   - Video tutoriales

4. **PWA (Progressive Web App):**
   - Instalable en m√≥viles
   - Funciona offline
   - Push notifications

---

### 3.9 Analytics y Tracking

**Herramientas:**

- Google Analytics 4
- Facebook Pixel
- Hotjar (mapas de calor)

**M√©tricas a Trackear:**

- Conversi√≥n de visitante a comprador
- Abandono de carrito
- Productos m√°s vistos
- Tiempo en sitio
- Flujo de navegaci√≥n

---

### 3.10 Optimizaci√≥n de Performance

**Implementaciones:**

1. **Image Optimization:**

```typescript
// next.config.js
module.exports = {
  images: {
    domains: ["images.pexels.com", "supabase.co"],
    formats: ["image/webp", "image/avif"],
  },
};
```

2. **Caching:**

   - Redis para cache de productos
   - SWR para cache del lado del cliente
   - ISR para p√°ginas est√°ticas

3. **Code Splitting:**

   - Dynamic imports
   - Route-based splitting
   - Component lazy loading

4. **CDN:**
   - Vercel Edge Network (ya incluido)
   - Cloudflare para assets

---

## üìã ROADMAP PRIORIZADO

### **Sprint 1 (Semana 1-2):** üî¥ CR√çTICO

1. ‚úÖ Panel de Administraci√≥n - Backend APIs
2. ‚úÖ Panel de Administraci√≥n - Dashboard UI
3. ‚úÖ Panel de Administraci√≥n - Gesti√≥n de Productos
4. ‚úÖ Panel de Administraci√≥n - Gesti√≥n de √ìrdenes

### **Sprint 2 (Semana 3):** üü° IMPORTANTE

5. ‚úÖ Sistema de Emails - Setup Resend
6. ‚úÖ Sistema de Emails - Templates
7. ‚úÖ Sistema de Emails - Integraci√≥n

### **Sprint 3 (Semana 4):** üü¢ DESEABLE

8. ‚úÖ Sistema de Reviews y Ratings
9. ‚úÖ Sistema de Cupones
10. ‚úÖ Mejoras de Seguridad (Rate Limiting, Audit Logs)

### **Sprint 4 (Semana 5-6):** üü¢ DESEABLE

11. ‚úÖ Tracking de Env√≠os
12. ‚úÖ Wishlist
13. ‚úÖ Notificaciones en Tiempo Real

### **Sprint 5 (Semana 7+):** üîµ FUTURO

14. ‚è≥ Programa de Referidos
15. ‚è≥ Analytics Avanzados
16. ‚è≥ PWA
17. ‚è≥ Optimizaciones de Performance

---

## üí∞ ESTIMACI√ìN DE COSTOS MENSUALES

### **Servicios Actuales:**

- ‚úÖ Vercel (Hobby): $0/mes
- ‚úÖ Supabase (Free): $0/mes
- ‚úÖ Stripe: 2.9% + $0.30 por transacci√≥n

### **Servicios Nuevos Necesarios:**

- üìß **Resend:**
  - Free: 3,000 emails/mes
  - Pro: $20/mes (50,000 emails)
- üìä **Analytics (Opcional):**
  - Google Analytics: $0 (gratis)
  - Mixpanel: $0-$25/mes
- üöÄ **Upstash Redis (Rate Limiting):**
  - Free: 10,000 requests/d√≠a
  - Pro: $10/mes

### **Estimaci√≥n Total:**

- **MVP:** $0-20/mes
- **Producci√≥n Peque√±a:** $30-50/mes
- **Producci√≥n Media:** $100-200/mes

---

## üéØ M√âTRICAS DE √âXITO

### **KPIs del Negocio:**

- üìà Conversi√≥n: % de visitantes que compran
- üí∞ Ticket Promedio: Valor promedio de orden
- üîÑ Tasa de Retorno: % de clientes que vuelven
- ‚≠ê Satisfacci√≥n: Rating promedio de reviews
- üì¶ Tiempo de Entrega: D√≠as promedio

### **KPIs T√©cnicos:**

- ‚ö° Performance: <3s carga inicial
- üêõ Error Rate: <1%
- üì± Mobile Usage: >60%
- üîê Security: 0 vulnerabilidades cr√≠ticas

---

## üìû PR√ìXIMOS PASOS INMEDIATOS

### **Para Empezar HOY:**

1. **Confirmar Prioridades:**

   - ¬øQu√© sprint quieres atacar primero?
   - ¬øAlguna funcionalidad adicional espec√≠fica?

2. **Preparar Ambiente:**

   ```bash
   # Instalar dependencias nuevas
   pnpm add recharts date-fns @tanstack/react-table react-dropzone resend

   # Crear estructura de carpetas
   mkdir -p app/admin/{products,categories,orders,analytics}
   mkdir -p components/admin/{dashboard,products,orders}
   mkdir -p lib/email/templates
   ```

3. **Setup de Servicios:**
   - Crear cuenta en Resend
   - Configurar dominio para emails
   - Revisar pol√≠ticas RLS en Supabase

---

## üìù NOTAS IMPORTANTES

1. **Seguridad:**

   - TODAS las rutas de admin deben validar rol
   - Implementar CSRF tokens
   - Rate limiting en todas las APIs p√∫blicas

2. **Performance:**

   - Cachear queries pesadas
   - Optimizar im√°genes
   - Lazy loading de componentes

3. **UX:**

   - Mantener feedback visual en todas las acciones
   - Loading states en todas las peticiones
   - Mensajes de error claros

4. **Testing:**
   - Probar flujos completos antes de merge
   - Test en m√≥vil
   - Test con datos reales

---

¬øPor cu√°l fase quieres que empecemos? üöÄ
